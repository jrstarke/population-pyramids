<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<title>Population Pyramids</title>
	<meta http-equiv="X-UA-Compatible" content="IE=9">
	<meta name="description" content="Population Pyramids showing age profiles and comparisons for any region of Canada.">
	<link rel="stylesheet" type="text/css" href="/lib/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="/population_pyramid.css" />
	
	<script type="text/javascript">
	
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-69155-30']);
	  _gaq.push(['_trackPageview',window.location.pathname+window.location.hash]);

	  (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();
	</script>
</head>
<body>
<div class="container">
    <div class="row-fluid">
        <div class="span12">
            <div class="alert alert-block alert-info">
                <button type="button" class="close" data-dismiss="alert">Ã—</button>
                <h4 class="alert-heading">Population pyramids</h4>
                <p>
                    show the distribution of the population
                    by age group and gender.
                    You can <b>enter the names of Canadian places</b> (Canada, provinces, agglomerations and municipalities)
                    into the fields below to show and compare their population pyramids.
                    The age distribution of the first place is shown as solid bars, and the age distribution of
                    the second place is shown as a line.
                    You can move the mouse over the age group in the pyramid to get detailed information.
                </p>
            </div>
            <h3 id="header">
                Population pyramid of
                <input type="text" class="search-query" id="select_main" tabindex="1"/>
                <span class="brand">compared to</span>
                <input type="text" class="search-query" id="select_compare" tabindex="2"/>
                <span class="brand">(line)</span>
                <span id="share" style="float: right; position: relative; top: 12px;">
                    <span class="addthis_toolbox addthis_default_style addthis_16x16_style">
                        <a class="addthis_button_facebook"></a>
                        <a class="addthis_button_twitter"></a>
                        <a class="addthis_button_compact"></a>
                    </span>
                    <script type="text/javascript">var addthis_config = {
                        "data_track_addressbar":true, data_ga_social : true,data_ga_property: 'UA-69155-30'
                    };</script>
                    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=jrstarke"></script>
                </span>
            </h3>
            <div id="loadingBox" class="alert alert-block alert-info fade in" style="display:none;">
                <h4 class="alert-heading">Loading...</h4>
                <p>The population pyramid should show in a second.</p>
            </div>
            <div id="mainErrorBox" class="alert alert-block alert-error fade in" style="display:none;">
                <h4 class="alert-heading" id="mainErrorMessage"></h4>
                <p>Check for typos or try entering a different place.</p>
            </div>
            <div id="compareErrorBox" class="alert alert-block alert-warn fade in" style="display:none;">
                <h4 class="alert-heading" id="compareErrorMessage"></h4>
                <p>Check for typos or try entering a different place.</p>
            </div>
            <div id="chart"></div>
        </div>
    </div>
    <hr/>
    <footer id="footer">
        <p>&copy; 2012 <a href="http://larsgrammel.de">Lars Grammel</a> and <a href="http://www.jamiestarke.com/">Jamie Starke</a>. Data from <a href="http://www.statcan.gc.ca/">Statistics Canada</a> 2011 Census.</p>
    </footer>
</div>
<script src="/lib/jquery.min.js"></script>
<script src="/lib/jshashtable-2.1.js"></script> <!-- numberformatter requirement -->
<script src="/lib/jquery.numberformatter-1.2.3.js"></script>
<script src="/lib/underscore.min.js"></script>
<script src="/lib/bootstrap-alert.js"></script>
<script src="/lib/bootstrap-typeahead.js"></script>
<script src="/lib/bootstrap-tooltip.js"></script>
<script src="/lib/bootstrap-popover.js"></script>
<script src="/lib/cpopover.js"></script>
<script src="/lib/d3.v2.js"></script>
<script src="/population_pyramid.js"></script>
<script>
    var currentMainId = undefined;
    var currentCompareId = undefined;

    d3.json('/regions.json', function(regions) {
        var regionIdLookupTable = {}
        _.each(regions, function(d) {
            regionIdLookupTable[d.name.toLowerCase()] = d.id;
        });

        var setupTypeahead = function(id) {
            $(id).typeahead({
                'source': _.map(regions, function(region) { return region.name; })
            });
            $(id).change(function(e){
                updatePyramid();
            });
            $(id).submit(function(e) {
                e.preventDefault();
                updatePyramid();
            });
            $(id).keydown(function(e) {
                if (e.keyCode == 13 && !$(id).data('typeahead').shown) {
                     updatePyramid();
                }
            });
        };

        var showMainError = function(mainName) {
            $('#mainErrorMessage').text("Place '" + mainName + "' not found.");
            $('#mainErrorBox').show();
        };
        var showCompareError = function(compareName) {
            $('#compareErrorMessage').text("Place '" + compareName + "' not found for comparison.");
            $('#compareErrorBox').show();
        };

        var updateInProgress = false;
        var updatePyramid = function(mainName, compareName) {
            if (updateInProgress) {
                return; // XXX UI elements should be deactivated
            }

            if (mainName === undefined) {
                mainName = $('#select_main').val();
            }
            if (compareName === undefined) {
                compareName = $('#select_compare').val();
            }

            var mainId = regionIdLookupTable[mainName.toLowerCase()];
            var compareId = regionIdLookupTable[compareName.toLowerCase()];

            if (mainId === currentMainId && compareId === currentCompareId) {
                return;
            } else {
                currentMainId = mainId;
                currentCompareId = compareId;
            }

            updateInProgress = true;

            $('#chart').empty();
            $('.popover').remove(); // remove open popovers

            if (mainId === undefined && compareId == undefined) {
                showMainError(mainName);
                showCompareError(compareName);
                updateInProgress = false;
            } else if (mainId === undefined) {
                showMainError(mainName);
                $('#compareErrorBox').hide();
                updateInProgress = false;
            } else if (compareId === undefined) {
                $('#mainErrorBox').hide();
                showCompareError(compareName);
                $('#loadingBox').show();

                d3.json('/region/' + mainId + '.json', function(data) {
                    renderChart(data, undefined, mainName, undefined);
                    updateInProgress = false;
                    $('#loadingBox').hide();
                });
            } else {
                $('#mainErrorBox').hide();
                $('#compareErrorBox').hide();
                $('#loadingBox').show();

                // TODO parallel loading
                d3.json('/region/' + mainId + '.json', function(data) {
                    d3.json('/region/' + compareId + '.json', function(compareData) {
                        renderChart(data, compareData, mainName, compareName);
                        updateInProgress = false;
                        $('#loadingBox').hide();
                    });
                });
            }
            window.location.hash = mainName.replace(/\s/g,'+') + '&' + compareName.replace(/\s/g,'+')
            window.document.title = "Population Pyramids - " + mainName + " compared to " + compareName;
            
            addthis_share = {
            	email_vars: { CustomText: 'Age profile of ' + mainName + ' compared to ' + compareName },
            	email_template: "pop_pyramid",
            	description: 'Age profile of ' + mainName + ' compared to ' + compareName,
            	templates: {
                   twitter: 'Age profile of ' + mainName + ' compared to ' + compareName+ ' {{url}} (by @jamiestarke and @lgrammel)',
               }
            };
            
            _gaq.push(['_trackPageview',window.location.pathname+window.location.hash]);
            _gat._getTrackerByName()._trackEvent('Region View', mainName, "Main Region");
            _gat._getTrackerByName()._trackEvent('Region View', compareName, "Comparison Region");
        }

        setupTypeahead('#select_main');
        setupTypeahead('#select_compare');
        
        if (window.location.hash)
        {
        	var comp = window.location.hash;
        	comp = comp.replace('#','')
        	comp = comp.replace(/\+/g,' ');
        	var pieces = comp.split('&');
        	
        	$("#select_main").val(pieces[0]);
        	$("#select_compare").val(pieces[1]);	
        	
        	updatePyramid(pieces[0],pieces[1]);
        }
        else
        {
	        $("#select_main").val('Capital, BC');
        	$("#select_compare").val('Canada');	
        	
        	updatePyramid('Capital, BC', 'Canada');
        }
    });
</script>
</body>
</html>