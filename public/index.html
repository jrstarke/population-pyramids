<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<title>Population Pyramids</title>
	<meta http-equiv="X-UA-Compatible" content="IE=9">
	<link rel="stylesheet" type="text/css" href="/lib/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="/population_pyramid.css" />
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="brand" href="#">Population Pyramid of</a>
            <form class="navbar-search" id="form_main">
                <input type="text" class="search-query" id="select_main" value="Victoria" />
            </form>
            <span class="brand">&nbsp;&nbsp;&nbsp;compared to</span>
            <form class="navbar-search" id="form_compare">
                <input type="text" class="search-query" id="select_compare" value="Canada" />
            </form>
        </div>
    </div>
</div>
<div class="container">
    <div id="mainErrorBox" class="row-fluid" style="display:none;">
        <div class="span12">
            <div class="alert alert-block alert-error fade in">
                <h4 class="alert-heading" id="mainErrorMessage"></h4>
                <p>Check for typos or try entering a different place.</p>
            </div>
        </div>
    </div>
    <div id="compareErrorBox" class="row-fluid" style="display:none;">
        <div class="span12">
            <div class="alert alert-block alert-warn fade in">
                <h4 class="alert-heading" id="compareErrorMessage"></h4>
                <p>Check for typos or try entering a different place.</p>
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div id="chart"></div>
        </div>
    </div>
    <hr/>
    <footer id="footer">
        <p>&copy; 2012 <a href="http://larsgrammel.de">Lars Grammel</a> and <a href="http://www.jamiestarke.com/">Jamie Starke</a>. Data from <a href="http://www.statcan.gc.ca/">Statistics Canada</a> 2011 Census.</p>
    </footer>
</div>
<script src="/lib/jquery.min.js"></script>
<script src="/lib/underscore.min.js"></script>
<script src="/lib/bootstrap-alert.js"></script>
<script src="/lib/bootstrap-typeahead.js"></script>
<script src="/lib/bootstrap-tooltip.js"></script>
<script src="/lib/bootstrap-popover.js"></script>
<script src="/lib/cpopover.js"></script>
<script src="/lib/d3.v2.js"></script>
<script src="/population_pyramid.js"></script>
<script>
    d3.json('/regions', function(regions) {
        var setupTypeahead = function(id) {
            $(id).typeahead({
                'source': _.map(regions, function(region) { return region.name; })
            });
            $(id).change(function(e){
                updatePyramid();
            });
        };

        var showMainError = function(mainName) {
            $('#mainErrorMessage').text("Place '" + mainName + "' not found.");
            $('#mainErrorBox').show();
        };
        var showCompareError = function(compareName) {
            $('#compareErrorMessage').text("Place '" + compareName + "' not found for comparison.");
            $('#compareErrorBox').show();
        };

        var updatePyramid = function(mainName, compareName) {
            if (mainName === undefined) {
                mainName = $('#select_main').val();
            }
            if (compareName === undefined) {
                compareName = $('#select_compare').val();
            }

            $('#chart').empty();
            $('.popover').remove(); // remove open popovers

            var mainId = regionIdLookupTable[mainName.toLowerCase()];
            var compareId = regionIdLookupTable[compareName.toLowerCase()];

            if (mainId === undefined && compareId == undefined) {
                showMainError(mainName);
                showCompareError(compareName);
            } else if (mainId === undefined) {
                showMainError(mainName);
                $('#compareErrorBox').hide();
            } else if (compareId === undefined) {
                $('#mainErrorBox').hide();
                showCompareError(compareName);

                d3.json('/region/' + mainId + '/data.json', function(data) {
                    renderChart(data);
                });
            } else {
                $('#mainErrorBox').hide();
                $('#compareErrorBox').hide();

                // TODO parallel loading
                d3.json('/region/' + mainId + '/data.json', function(data) {
                    d3.json('/region/' + compareId + '/data.json', function(compareData) {
                        console.log("x");
                        renderChart(data, compareData);
                    });
                });
            }
        }

        setupTypeahead('#select_main');
        setupTypeahead('#select_compare');

        var regionIdLookupTable = {}
        _.each(regions, function(d) {
            regionIdLookupTable[d.name.toLowerCase()] = d.id;
        });

        var onSubmit = function(e) {
            e.preventDefault();
            updatePyramid();
        };

        $("#form_main").submit(onSubmit);
        $("#form_compare").submit(onSubmit);

        updatePyramid('Victoria', 'Canada');
    });
</script>
</body>
</html>